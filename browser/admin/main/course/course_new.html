<div class="body-in" id="top">
	<div class="layui-card-body">
		<div id="alternative">
			<div class="layui-tab layui-tab-brief" lay-filter="docDemoTabBrief">
				<ul class="layui-tab-title">
					<li class="layui-this">新增正式课程</li>
					<li>新增免费课程</li>
				</ul>
				<div class="layui-tab-content" style="height: 100px;">
					<div class="layui-tab-item layui-show">
						<form class="layui-form" name="new_course_form_formal" method="post">
							<p class="form-label_sm">课程名称</p>
							<input type="text" id="coursename" name="coursename" lay-verify="title required" autocomplete="off" placeholder="请输入课程名称" class="layui-input">
							<p class="form-label_sm">课程状态</p>
							<select name="coursestatus" id="coursestatus" lay-verify="required" lay-search="">
								<option value="">直接选择或搜索选择</option>
								<option value="进行中">进行中</option>
								<option value="已结束">已结束</option>
								<option value="即将开始">即将开始</option>
							</select>
							<p class="form-label_sm">课程类别</p>
							<select id="categories_s" name="coursecategory" lay-filter="categories-select" lay-verify="required" lay-search="">
								<option value="直接选择或搜索选择">直接选择或搜索选择</option>
								<option value="前端">前端</option>
								<option value="Java">Java</option>
								<option value="Java Web">Java Web</option>
								<option value="0">自定义</option>
							</select>
							<p id="categories_p"></p>
							<p class="form-label_sm">课程图片</p>
							<div class="layui-upload">
								<div class="layui-upload-drag" id="uploadpic">
									<i class="layui-icon">&#xe681;</i>
									<p>点击上传，或将图片拖拽到此处</p>
								</div>
								<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
									预览图：
									<div><img id="pic" /></div>
									<p id="demoText"></p>
								</blockquote>
							</div>
							<p class="form-label_sm">课程定价</p>
							<input type="text" id="courseprice" name="courseprice" lay-verify="price required" autocomplete="off" placeholder="￥" class="layui-input">
							<p class="form-label_sm">开本课程的分部</p>
							<div class="layui-input-block" id="branch_sel">
								<!--<input type="checkbox" name="fenbu1" title="实训中心">
								<input type="checkbox" name="fenbu2" title="学校基地">
								<input type="checkbox" name="fenbu3" title="大连软件园">-->
							</div>
							<p class="form-label_sm">课程描述</p>
							<script type="text/plain" id="myEditor_formal" style="height:240px;"></script>
							<p class="form-label_sm"></p>
							<button type="button" id="submit_pay_btn" class="layui-btn">发表</button>
							<script type="text/javascript">
								//实例化编辑器
								var um_formal = UM.createEditor('myEditor_formal');
								um_formal.setWidth("100%");
								$(".edui-body-container").css("width", "98%");
							</script>
						</form>
					</div>
					<div class="layui-tab-item">
						<form class="layui-form" name="new_course_form_exp" action="" method="post">
							<p class="form-label_sm">课程名称</p>
							<input type="text" name="coursename" id="coursename_f" lay-verify="title required" autocomplete="off" placeholder="请输入课程名称" class="layui-input">
							<p class="form-label_sm">课程状态</p>
							<select name="coursestatus" id="coursestatus_f" lay-verify="required" lay-search="">
								<option value="">直接选择或搜索选择</option>
								<option value="进行中">进行中</option>
								<option value="已结束">已结束</option>
								<option value="即将开始">即将开始</option>
							</select>
							<p class="form-label_sm">课程类别</p>
							<select id="categories_s_f" name="coursecategory" lay-filter="categories-select" lay-verify="required" lay-search="">
								<option value="直接选择或搜索选择">直接选择或搜索选择</option>
								<option value="前端">前端</option>
								<option value="Java">Java</option>
								<option value="Java Web">Java Web</option>
								<option value="0">自定义</option>
							</select>
							<p id="categories_p"></p>
							<p class="form-label_sm">课程图片</p>
							<div class="layui-upload">
								<div class="layui-upload-drag" id="uploadpic2">
									<i class="layui-icon">&#xe681;</i>
									<p>点击上传，或将图片拖拽到此处</p>
								</div>
								<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;">
									预览图：
									<div><img id="pic2" /></div>
									<p id="demoText"></p>
								</blockquote>
							</div>
							<p class="form-label_sm">开本课程的分部</p>
							<select id="fenbu_f" name="fenbu" lay-filter="categories-select" lay-verify="required" lay-search="">
								<option value="">直接选择或搜索选择</option>
								<!--<option value="实训中心">实训中心</option>
								<option value="大连软件园">大连软件园</option>
								<option value="世纪路">世纪路</option>
								<option value="学校基地">学校基地</option>-->
							</select>
							<p class="form-label_sm">课程描述</p>
							<script type="text/plain" id="myEditor_free" style="height:240px;"></script>
							<p class="form-label_sm"></p>
							<button type="button" id="submit_free_btn" class="layui-btn">发表</button>
							<script type="text/javascript">
								//实例化编辑器
								var um_free = UM.createEditor('myEditor_free');
								um_free.setWidth("100%");
								$(".edui-body-container").css("width", "98%");
							</script>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		var imgFile = null;
		//JavaScript代码区域

		//上传图片
		layui.use('upload', function() {
			var $ = layui.jquery,
				upload = layui.upload;

			upload.render({
				elem: '#uploadpic',
				auto: false,
				acceptMime: 'image/*',
				size: 1000 //限制文件大小，单位 KB
					,
				choose: function(obj) {
					//预读本地文件示例，不支持ie8
					obj.preview(function(index, file, result) {
						$('#pic-div').show();
						imgFile = file;
						$('#pic').attr('src', result); //图片链接（base64）
					});
				}
			});
			upload.render({
				elem: '#uploadpic2',
				auto: false,
				acceptMime: 'image/*',
				size: 1000 //限制文件大小，单位 KB
					,
				choose: function(obj) {
					//预读本地文件示例，不支持ie8
					obj.preview(function(index, file, result) {
						$('#pic-div').show();
						imgFile = file;
						$('#pic2').attr('src', result); //图片链接（base64）
					});
				}
			});
		});
		layui.use(['form', 'layedit', 'laydate'], function() {
			var form = layui.form,
				layer = layui.layer,
				$ = layui.jquery,
				layedit = layui.layedit,
				laydate = layui.laydate;

			form.render();

			form.on('select(categories-select)', function(data) {
				console.log(data.elem); //得到select原始DOM对象
				console.log(data.value); //得到被选中的值
				console.log(data.othis); //得到美化后的DOM对象
				if(data.value == 0) {
					console.log(data.value); //得到被选中的值
					//							var categories = $('#categoriess_s');
					var categories_p = $('#categories_p');
					categories_p.show();
					//							categories.hide();
					categories_p.html('<input type="text" name="lebie" autocomplete="off" placeholder="请输入自定义类别名称" class="layui-input">');
				} else if(data.value > 0) {
					$('#categories_p').hide();
				}
			});
		});
		$(function() {
			//获取分部信息，填充到下拉框的地方
			$.ajax({
				type:"get",
				url:"/admin/getBranchesName",
				async:true,
				dataType: "json",
				success: function(data) {
					console.log("分部信息获取成功");
					$.each(data.values, function(index, value) {
						$("#fenbu_f").append('<option value="' + value + '">' + value + '</option>');
						$("#branch_sel").append('<input type="checkbox" name="' + value + '" title="' + value + '">');
					});
				},
				error:function() {
					console.log("分部信息获取失败，服务器错误");
					$("#fenbu_f").append('<option value="服务器错误，请重试或联系系统管理员" disabled>服务器错误，请重试或联系系统管理员</option>');
					$("#branch_sel").append('<input type="checkbox" name="服务器错误" title="服务器错误，请重试或联系系统管理员" disabled />');
				}
			});

			$("#submit_pay_btn").click(function() {
				//验证
				if(!/^\d+(\.\d+)?$/.test($("#courseprice").val())) {
					layer_out("价钱格式不正确，请检查后重新输入");
					return;
				}
				if(!(required_verify("课程名称", $('#coursename').val()))) {
					return ;
				}
				
				var formData = new FormData();
				var branchs_s = $("#branch_sel input:checked");
				var branch = new Array();
				for(var i in branchs_s) {
					branch.push(branchs_s[i].name);
				}

				formData.append("lname", $('#coursename').val());
				formData.append("imgFile", imgFile);
				formData.append("lprice", $("#courseprice").val());
				formData.append("ldesc", um_formal.getContent());
				formData.append("status", $('#coursestatus option:selected').text());
				formData.append("category", $('#categories_s option:selected').text());
				formData.append("branchs", branch);

				jqxhr = $.ajax({
					type: "post",
					url: PREPATH + "/admin/saveLesson",
					async: true,
					dataType: "json",
					data: formData,
					processData: false,
					contentType: false,
					success: function(data) {
						console.log(data);
						if(data.response == 1) {
							layer.open({
								type: 0,
								btn: false,
								title: false,
								icon: 1,
								closeBtn: 0,
								shadeClose: true,
								time: 1500,
								content: '课程添加成功！',
								success: function() {
									window.location.href = "#21";
								}
							});
							window.location.href = "#21";
						} else {
							layer.open({
								type: 0,
								btn: false,
								title: false,
								icon: 2,
								closeBtn: 0,
								shadeClose: true,
								time: 1500,
								content: '课程添加失败，请稍后重试或联系系统管理员'

							});
						}
					},
					error: function() {
						layer.open({
							type: 0,
							btn: false,
							title: false,
							icon: 2,
							closeBtn: 0,
							shadeClose: true,
							time: 1500,
							content: '服务器错误，请稍后重试或联系系统管理员'

						});
					}
				});
			});
			$("#submit_free_btn").click(function() {
				
				if(!(required_verify("课程名称", $('#coursename_f').val()))) {
					return ;
				}
				
				var formData = new FormData();
				var branch = $("#fenbu_f input:selected").text();

				formData.append("title", $('#coursename_f').val());
				formData.append("imgFile", imgFile);
				formData.append("fdesc", um_free.getContent());
				formData.append("status", $('#coursestatus_f option:selected').text());
				formData.append("category", $('#categories_s_f option:selected').text());
				formData.append("branchName", branch);

				jqxhr = $.ajax({
					type: "post",
					url: PREPATH + "/admin/saveFreeListen",
					async: true,
					data: formData,
					dataType: "json",
					processData: false,
					contentType: false,
					success: function(data) {
						console.log(data);
						if(data.response == "1") {
							layer.open({
								type: 0,
								btn: false,
								title: false,
								icon: 1,
								closeBtn: 0,
								shadeClose: true,
								time: 1500,
								content: '课程更新成功！',
								success: function() {
									window.location.href = "#21";
								}
							});
						} else {
							layer.open({
								type: 0,
								btn: false,
								title: false,
								icon: 2,
								closeBtn: 0,
								shadeClose: true,
								time: 1500,
								content: '课程更新失败，请稍后重试或联系系统管理员'

							});
						}
					},
					error: function() {
						layer.open({
							type: 0,
							btn: false,
							title: false,
							icon: 2,
							closeBtn: 0,
							shadeClose: true,
							time: 1500,
							content: '课程更新失败，请稍后重试或联系系统管理员'

						});
					}
				});
			});
		});
	</script>