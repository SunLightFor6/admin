<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Education</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<!--标准mui.css-->
		<link rel="stylesheet" href="css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="css/extra-icons_modify.css" />
		<link rel="stylesheet" type="text/css" href="css/icons-extra.css" />
		<link rel="stylesheet" type="text/css" href="fonts/mui-icons-extra.ttf" />
		<!--App自定义的css-->
		<link rel="stylesheet" type="text/css" href="css/app.css" />
		<link rel="stylesheet" type="text/css" href="css/loaders.min.css"/>
		<link rel="stylesheet" type="text/css" href="css/loading.css"/>
		<script src="js/jquery.min.js" type="text/javascript"></script>
			<script src="js/config.js" type="text/javascript"></script>
		<script src="js/loading.animation.js" type="text/javascript"></script>
		<style>
			.portrait {
				border-radius: 50%;
				width: 37%;
				border: 4px solid;
				border-color: #FFFFFF;
			}
			.mui-table-view-cell {
				height: 55px;
				padding: 15px;
				font-size: 19px;
				color: #333333;
			}
		</style>
	</head>
	<!--loading页开始-->
	<div class="loading">
		<div class="loader">
	        <div class="loader-inner pacman">
	          <div></div>
	          <div></div>
	          <div></div>
	          <div></div>
	          <div></div>
	        </div>
		</div>
	</div>
	<!--loading页结束-->
	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">我的头像</h1>
		</header>
		<div class="mui-content">
			<div style="background-image: url(images/background.jpg); width: 100%; height: 256px; margin-top: 25px;">
				<center style="padding-top: 15%;">
					<a href="#upload">
						<img src="images/portrait.jpg" class="portrait" id="portrait"/>
					</a>
				</center>
			</div>
		</div>
		<div id="upload" class="mui-popover mui-popover-action mui-popover-bottom">
			<ul class="mui-table-view" style="margin-bottom: 16px;">
				<li class="mui-table-view-cell">
					<a id="camera">拍照</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="gallery">从相册选取</a>
				</li>
			</ul>
			<ul class="mui-table-view" style="margin-bottom: 13px;">
				<li class="mui-table-view-cell">
					<a href="#upload">取消</a>
				</li>
			</ul>
		</div>
	</body>
	<script src="js/mui.min.js"></script>
	<script>
		
		mui.init({
			swipeBack: true //启用右滑关闭功能
		});
		
		mui.ready(function () {
			mui("#upload").class="mui-popover mui-popover-action mui-popover-bottom mui-active mui-visibility";
		});
		
		//拍照
		document.getElementById('camera').addEventListener('tap',function(){
	        var mobileCamera=plus.camera.getCamera();
	        mobileCamera.captureImage(function(e){
	            plus.io.resolveLocalFileSystemURL(e,function(entry){
	                var path=entry.toLocalURL();
	                uploadHeadImg(path);
	            },function(err){
	                console.log("读取拍照文件错误");
	            });
	        },function(e){
	            console.log("er",err);
	        },function(){
	            filename:'portrait.png';
	        });
	    }
		
	    //从本地相册选择
	   document.getElementById('gallery').addEventListener('tap',function(){
	        console.log("你选择了从相册选择");
	        plus.gallery.pick(function(a){
	            plus.io.resolveLocalFileSystemURL(a,function(entry){
	                plus.io.resolveLocalFileSystemURL('',function(root){
	                    root.getFile('portrait.png',{},function(file){
	                        //文件已经存在
	                        file.remove(function(){
	                            console.log("文件移除成功");
	                            entry.copyTo(root,'portrait.png',function(e){
	                                var path=e.fullPath;
	                                uploadHeadImg(path);
	                            },function(err){
	                                console.log("copy image fail: ",err);
	                            });
	                        },function(err){
	                            console.log("删除图片失败：（"+JSON.stringify(err)+")");
	                        });
	                    },function(err){
	                        //打开文件失败
	                        entry.copyTo(root,'portrait.png',function(e){
	                            var path=e.fullPath;
	                            uploadHeadImg(path);
	                        },function(err){
	
	                            console.log("上传图片失败：（"+JSON.stringify(err)+")");
	                        });
	                    });
	                },function(e){
	                    console.log("读取文件夹失败：（"+JSON.stringify(err)+")");
	                });
	            });
	        },function(err){
	            console.log("读取拍照文件失败: ",err);
	        },{
	            filter:'image'
	        });
	    };
	
	    //上传图片
	    function uploadHeadImg(imgPath){
	        //选中图片之后，头像当前的照片变为选择的照片
	        var mainImg=document.getElementById("portrait");
	        mainImg.src=imgPath;	
	        var images=new Image();
	        images.src=imgPath;
	        var imgData=getBase64Image(images);
	        mui.ajax('http://127.0.0.1/uploadHeadImg',{
	            data:{
	                'imgDatas':imgData
	            },
	            dataType:'json',//服务器返回json格式数据
	            type:'post',//HTTP请求类型
	            timeout:10000,//超时时间设置为10秒
	            xhrFields: {  
					withCredentials: true  
				},  
				crossDomain: true,
	            success:function(data){ 
	                if(data.status=='1'){
	                    mui.alert('上传成功！');
	                }
	            },
	            error:function(xhr,type,errorThrown){
	                if(type=='timeout'){
	                    mui.alert('服务器连接超时，请稍后再试');
	                }   
	            }
	        });
	    }
	
	
	    //压缩图片转成base64
	    function getBase64Image(img){
	        var canvas=document.createElement("canvas");
	        var width=img.width;
	        var height=img.height;
	        if(width>height){
	            if(width>100){
	                height=Math.round(height*=100/width);
	                width=100;
	            }
	        }else{
	            if(height>100){
	                width=Math.round(width*=100/height);
	            }
	            height=100;
	        }
	        canvas.width=width;
	        canvas.height=height;
	        var ctx=canvas.getContext('2d');
	        ctx.drawImage(img,0,0,width,height);	
	        var dataUrl=canvas.toDataURL('image/png',0.8);
	        return dataUrl.replace('data:image/png:base64,','');
	    }   
	
	</script>

</html>